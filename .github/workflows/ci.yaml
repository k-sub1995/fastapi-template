name: CI

on:
  push:
    branches: ['**']
    tags:
      - 'v*'
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: ['main', 'develop']
    paths-ignore:
      - 'docs/**'
      - '**.md'

permissions:
  contents: read

jobs:
  backend:
    name: Backend (Python)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version-file: "pyproject.toml"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Lint with Ruff
        run: uv run ruff check .

      - name: Format check with Ruff
        run: uv run ruff format --check .

      - name: Run tests
        run: uv run pytest -v

  notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: backend
    if: failure()
    steps:
      - name: Notify Slack on Failure
        uses: rtCamp/action-slack-notify@cdf0a2130cbcdfd82ba5fcac8e076370bf381b36 # v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: '‚ùå CI Failed'
          SLACK_MESSAGE: |
            <@U06Q4AVJUPJ> CI workflow failed.
            *Branch:* `${{ github.ref_name }}`
            *Commit:* `${{ github.sha }}`
            *Actor:* ${{ github.actor }}
            *Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_FOOTER: 'FastAPI Template CI'